---

- op: add
  path: /machine/certSANs
  value:
    - $ENDPOINT

- op: add
  path: /machine/kubelet
  value:
    extraArgs:
      feature-gates: GracefulNodeShutdown=true,MixedProtocolLBService=true
      rotate-server-certificates: "true"

- op: add
  path: /machine/network/interfaces
  value:
    - interface: eth0
      addresses:
        - $ENDPOINT/24
      routes:
        - network: 0.0.0.0/0
          gateway: 192.168.122.1
      mtu: 1500
      dhcp: true
      vip:
        ip: 192.168.122.10
    - interface: eth1
      addresses:
        - 192.168.10.0/24
      routes:
        - network: 0.0.0.0/0
          gateway: 192.168.10.1
      mtu: 1500
      dhcp: false

- op: add
  path: /machine/network/hostname
  value: $HOSTNAME

- op: add
  path: /machine/network/nameservers
  value:
    - 1.1.1.1
    - 8.8.8.8

- op: add
  path: /machine/disks
  value:
    - device: /dev/vdb
      partitions:
        - mountpoint: /var/mnt/extra

- op: add
  path: /machine/install
  value:
    disk: /dev/vda
    extraKernelArgs:
      - talos.logging.kernel=udp://192.168.10.2:6050/

- op: add
  path: /machine/logging
  value:
    destinations:
      - endpoint: udp://192.168.10.2:6051/
        format: json_lines

- op: add
  path: /machine/time
  value:
    disabled: false
    servers:
      - time.cloudflare.com

- op: add
  path: /machine/files
  value:
    - content: |
        [plugins."io.containerd.grpc.v1.cri"]
          enable_unprivileged_ports = true
          enable_unprivileged_icmp = true
      path: /var/cri/conf.d/allow-unpriv-ports.toml
      op: create

- op: add
  path: /cluster/network/cni
  value:
    name: custom
    urls:
      - https://github.com/chamburr/homelab/blob/master/talos/cilium/install.yaml

- op: add
  path: /cluster/apiServer
  value:
    admissionControl: []
    certSANs:
      - $ENDPOINT
    extraArgs:
      feature-gates: MixedProtocolLBService=true,EphemeralContainers=True

- op: add
  path: /cluster/controllerManager
  value:
    extraArgs:
      feature-gates: MixedProtocolLBService=true,EphemeralContainers=True

- op: add
  path: /cluster/proxy
  value:
    disabled: true
    extraArgs:
      feature-gates: MixedProtocolLBService=true,EphemeralContainers=True

- op: add
  path: /cluster/scheduler
  value:
    extraArgs:
      feature-gates: MixedProtocolLBService=true,EphemeralContainers=True

- op: add
  path: /cluster/discovery/registries
  value:
    service:
      disabled: true

- op: add
  path: /cluster/extraManifests
  value:
    - https://raw.githubusercontent.com/alex1989hu/kubelet-serving-cert-approver/v0.5.1/deploy/ha-install.yaml
