---
- op: add
  path: /machine/certSANs
  value:
    - 192.168.122.10

- op: add
  path: /machine/kubelet/extraArgs
  value:
    feature-gates: MixedProtocolLBService=true,GracefulNodeShutdown=true
    rotate-server-certificates: "true"

- op: add
  path: /machine/network/interfaces
  value:
    - interface: eth0
      addresses:
        - $ENDPOINT/24
      routes:
        - network: 0.0.0.0/0
          gateway: 192.168.122.1
      mtu: 1500
      dhcp: false
      vip:
        ip: 192.168.122.10

- op: add
  path: /machine/network/hostname
  value: $HOSTNAME

- op: add
  path: /machine/network/nameservers
  value:
    - 192.168.122.1

- op: add
  path: /machine/install/disk
  value: /dev/sda

- op: add
  path: /machine/install/extraKernelArgs
  value:
    - talos.logging.kernel=udp://192.168.122.100:6050/

- op: add
  path: /machine/logging
  value:
    destinations:
      - endpoint: udp://192.168.122.100:6051/
        format: json_lines

- op: add
  path: /machine/files
  value:
    - content: |
        [plugins."io.containerd.grpc.v1.cri"]
          enable_unprivileged_ports = true
          enable_unprivileged_icmp = true
      path: /var/cri/conf.d/allow-unpriv-ports.toml
      op: create

- op: add
  path: /cluster/allowSchedulingOnControlPlanes
  value: true

- op: add
  path: /cluster/network/cni
  value:
    name: custom
    urls:
      - https://raw.githubusercontent.com/chamburr/homelab/master/scripts/cilium/install.yaml

- op: replace
  path: /cluster/apiServer/admissionControl
  value: []

- op: add
  path: /cluster/apiServer/certSANs
  value:
    - 192.168.122.10

- op: add
  path: /cluster/apiServer/extraArgs
  value:
    feature-gates: MixedProtocolLBService=true

- op: add
  path: /cluster/controllerManager/extraArgs
  value:
    feature-gates: MixedProtocolLBService=true

- op: add
  path: /cluster/proxy/disabled
  value: true

- op: add
  path: /cluster/proxy/extraArgs
  value:
    feature-gates: MixedProtocolLBService=true

- op: add
  path: /cluster/scheduler/extraArgs
  value:
    feature-gates: MixedProtocolLBService=true

- op: add
  path: /cluster/discovery/registries
  value:
    service:
      disabled: true

- op: add
  path: /cluster/extraManifests
  value:
    - https://raw.githubusercontent.com/Didstopia/kubelet-serving-cert-approver/2407299/deploy/ha-install.yaml
