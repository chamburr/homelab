---
- name: Install kvm packages
  ansible.builtin.dnf:
    name:
      - qemu-img
      - qemu-kvm
      - libvirt
      - virt-install
    state: present

- name: Enable kvm service
  ansible.builtin.systemd:
    name: "{{ item }}"
    enabled: true
    state: started
  loop:
    - virtqemud
    - virtinterfaced.socket
    - virtnetworkd.socket
    - virtnodedevd.socket
    - virtnwfilterd.socket
    - virtproxyd.socket
    - virtsecretd.socket
    - virtstoraged.socket

- name: Start virtual network
  community.libvirt.virt_net:
    autostart: true
    name: default
    state: active

- name: Create virtual disk
  ansible.builtin.shell:
    cmd: |
      virsh vol-create-as default {{ volume_name }} {{ volume_size }} \
        --format {{ volume_format }}
    creates: /var/lib/libvirt/images/{{ volume_name }}

- name: Get vms
  community.libvirt.virt:
    command: list_vms
  register: all_vms

- name: Download vm image
  ansible.builtin.get_url:
    url: "{{ vm_image }}"
    dest: /var/lib/libvirt/images/install.iso
    mode: 0644
  when: all_vms.list_vms | length == 0

- name: Create vms
  ansible.builtin.shell:
    cmd: |
      virt-install --name={{ item.key }} \
        --cpu=host --vcpus={{ vm_cpu }} --ram={{ vm_ram }} \
        --os-type=linux --os-variant=generic \
        --cdrom=/var/lib/libvirt/images/install.iso \
        --disk=pool=default,size={{ vm_disk }} \
        --disk=vol=default/{{ vm_volume }},cache=none,io=native,perms=sh \
        --network=network=default \
        --graphics=none --noautoconsole --autostart
  with_dict: "{{ vms }}"
  when: all_vms.list_vms | length == 0

- name: Detach vm image
  ansible.builtin.command:
    cmd: virsh detach-disk {{ item.key }} hdc --config
  with_dict: "{{ vms }}"
  when: all_vms.list_vms | length == 0

- name: Delete vm image
  ansible.builtin.command:
    cmd: virsh vol-delete --pool default install.iso
  when: all_vms.list_vms | length == 0

- name: Wait for vm installation
  ansible.builtin.pause:
    seconds: 30
  when: all_vms.list_vms | length == 0
