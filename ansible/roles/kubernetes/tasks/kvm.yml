---
- name: Install kvm packages
  ansible.builtin.dnf:
    name:
      - qemu-img
      - qemu-kvm
      - libvirt
      - virt-install
    state: present

- name: Enable kvm service
  ansible.builtin.service:
    name: libvirtd
    enabled: true
    state: present

- name: Start virtual network
  community.libvirt.virt_net:
    autostart: true
    command: start
    name: default
    state: active

- name: Create virtual disk
  ansible.builtin.command:
    cmd: >
      virsh vol-create-as default {{ volume_name }} {{ volume_size }} \
        --format {{ volume_format }}
    creates: /var/lib/libvirt/images/{{ volume_name }}

- name: Get virtual machines
  community.libvirt.virt:
    command: list_vms
  register: all_vms

- name: Create virtual machines
  ansible.builtin.command:
    cmd: >
      virt-install --name={{ item }} \
        --cpu=host --vcpus={{ vm_cpu }} --ram={{ vm_ram }} \
        --os-type=linux --os-variant=generic \
        --boot=cdrom,hd,network --cdrom={{ vm_image }} \
        --disk=pool=default,size={{ vm_disk }} \
        --disk=vol=default/{{ vm_volume }},cache=none,io=native \
        --network=bridge={{ vm_bridge }} --network=network=default \
        --graphics=none --noautoconsole --autostart
  loop: "{{ vms }}"
  when: all_vms | length == 0
