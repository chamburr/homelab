---
- name: Install firewall package
  ansible.builtin.dnf:
    name: firewalld
    state: present

- name: Enable firewall service
  ansible.builtin.service:
    name: firewalld
    enabled: true
    state: started

- name: Allow firewall masquerade
  ansible.posix.firewalld:
    masquerade: true
    permanent: true
    immediate: true
    state: enabled

- name: Configure firewall services
  ansible.posix.firewalld:
    service: "{{ item.key }}"
    permanent: true
    immediate: true
    state: "{{ item.value }}"
  with_dict: "{{ firewall_services }}"

- name: Configure firewall ports
  ansible.posix.firewalld:
    port: "{{ item.key }}"
    permanent: true
    immediate: true
    state: "{{ item.value }}"
  with_dict: "{{ firewall_ports }}"

- name: Configure firewall forwarding
  ansible.posix.firewalld:
    port_forward:
      - port: "{{ item.split('/').0 }}"
        proto: "{{ item.split('/').1 }}"
        toaddr: "{{ firewall_forward_address }}"
        toport: "{{ item.split('/').0 }}"
    permanent: true
    immediate: true
    state: enabled
  loop: "{{ firewall_forward_ports }}"
