---

- name: Enable ssh service
  ansible.builtin.service:
    name: sshd
    enabled: true
    state: started

- name: Update ssh configuration
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    validate: sshd -T -f %s
    state: present
  loop:
    - regexp: ^PasswordAuthentication
      line: PasswordAuthentication no
    - regexp: ^PermitRootLogin
      line: PermitRootLogin no
  notify: Restart ssh service

- name: Override ssh configuration
  ansible.builtin.blockinfile:
    path: /etc/ssh/sshd_config
    block: |
      Match Address 10.0.0.0/8
      PasswordAuthentication yes
    validate: sshd -T -f %s
    state: present
