---

- name: Install mdadm package
  ansible.builtin.dnf:
    name: mdadm
    state: present

- name: Check array
  ansible.builtin.command:
    cmd: cat /proc/mdstat | grep md0
  register: array_check
  changed_when: false
  failed_when: false
  check_mode: false

- name: Create array
  ansible.builtin.command:
    cmd: yes | mdadm --create /dev/md0 --level=1 --raid-devices=2 /dev/sda /dev/sdb
  register: array_create
  when: array_check.results[0].rc != 0

- name: Create array filesystem
  ansible.general.filesystem:
    fstype: ext4
    dev: /dev/md0
    state: present

- name: Mount array filesystem
  ansible.posix.mount:
    path: /mnt/md0
    src: /dev/md0
    fstype: ext4
    state: mounted

- name: Get array details
  ansible.builtin.command:
    cmd: mdadm --detail --scan
  register: array_details
  changed_when: false
  when: array_create is changed

- name: Update mdadm config
  ansible.builtin.lineinfile:
    path: /etc/mdadm.conf
    regexp: ^{{ item }}
    line: "{{ item }}"
    state: present
  loop: "{{ array_details.stdout_lines }}"
  when: array_create is changed

- name: Update initramfs
  ansible.builtin.command:
    cmd: dracut -f
  when: array_create is changed
