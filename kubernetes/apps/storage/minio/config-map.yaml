---
apiVersion: v1
kind: ConfigMap
metadata:
  name: minio
  namespace: storage
data:
  # https://github.com/bitnami/containers/blob/main/bitnami/minio/2022/debian-11/rootfs/opt/bitnami/scripts/minio/run.sh
  run-new.sh: |
    #!/bin/bash

    # shellcheck disable=SC1091

    set -o errexit
    set -o nounset
    set -o pipefail
    #set -o xtrace

    # Load libraries
    . /opt/bitnami/scripts/liblog.sh
    . /opt/bitnami/scripts/libos.sh
    . /opt/bitnami/scripts/libminio.sh

    # Load MinIO environment
    . /opt/bitnami/scripts/minio-env.sh

    # Constants
    EXEC=$(command -v minio)
    ARGS=("server" "--certs-dir" "$MINIO_CERTS_DIR" "--console-address" ":$MINIO_CONSOLE_PORT_NUMBER" "--address" ":$MINIO_API_PORT_NUMBER")
    # Add any extra flags passed to this script
    ARGS+=("$@")
    if is_boolean_yes "$MINIO_DISTRIBUTED_MODE_ENABLED"; then
      read -r -a nodes <<< "$(tr ',;' ' ' <<< "$MINIO_DISTRIBUTED_NODES")"
      for node in "$${nodes[@]}"; do
        if is_distributed_ellipses_syntax; then
          ARGS+=("$MINIO_SCHEME://$node")
        else
          ARGS+=("$MINIO_SCHEME://$node:$MINIO_API_PORT_NUMBER/$MINIO_DATA_DIR")
        fi
      done
    else
      ARGS+=("$MINIO_DATA_DIR")
    fi

    info "** Starting MinIO **"
    exec "$EXEC"  "$${ARGS[@]}"
