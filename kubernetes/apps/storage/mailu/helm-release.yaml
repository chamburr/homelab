---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: mailu
  namespace: storage
spec:
  interval: 15m
  chart:
    spec:
      chart: mailu
      version: 0.3.3
      sourceRef:
        kind: HelmRepository
        name: mailu
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    # renovate source=github-releases name=Mailu/Mailu
    mailuVersion: 1.9.39
    hostnames:
      - mail.${DOMAIN}
    subnet: ${K8S_POD_CIDR}
    postmaster: postmaster
    mail:
      messageSizeLimitInMegabytes: 100
      messageRatelimit: 200/hour
    certmanager:
      enabled: false
    front:
      hostPort:
        enabled: false
      externalService:
        enabled: true
        type: LoadBalancer
        loadBalancerIP: ${LB_MAILU}
        externalTrafficPolicy: Local
        pop3:
          pop3: false
          pop3s: false
        imap:
          imap: false
          imaps: true
        smtp:
          smtp: false
          smtps: false
          submission: true
    rspamd:
      resources:
        requests:
          cpu: 500m
          memory: 500Mi
        limits:
          cpu: 600m
          memory: 600Mi
    clamav:
      enabled: false
    roundcube:
      enabled: false
    webdav:
      enabled: false
    fetchmail:
      enabled: false
    persistence:
      single_pvc: true
    ingress:
      externalIngress: true
      className: traefik
  valuesFrom:
    - kind: Secret
      name: mailu-secret
      valuesKey: secret
      targetPath: secretKey
    - kind: Secret
      name: mailu-secret
      valuesKey: domain
      targetPath: domain
  postRenderers:
    - kustomize:
        patchesStrategicMerge:
          - $patch: delete
            apiVersion: v1
            kind: PersistentVolumeClaim
            metadata:
              name: mailu-storage
        patchesJson6902:
          - target:
              kind: Deployment
              name: mailu-redis
            patch:
              - op: add
                path: /spec/template/spec/volumes/0/persistentVolumeClaim/claimName
                value: mailu-redis
              - op: replace
                path: /spec/strategy
                value:
                  type: Recreate
          - target:
              kind: Deployment
              name: mailu-admin
            patch:
              - op: add
                path: /spec/template/spec/volumes/0/persistentVolumeClaim/claimName
                value: mailu-admin
              - op: replace
                path: /spec/strategy
                value:
                  type: Recreate
          - target:
              kind: Deployment
              name: mailu-dovecot
            patch:
              - op: add
                path: /spec/template/spec/volumes/0/persistentVolumeClaim/claimName
                value: mailu-dovecot
              - op: replace
                path: /spec/strategy
                value:
                  type: Recreate
          - target:
              kind: Deployment
              name: mailu-postfix
            patch:
              - op: add
                path: /spec/template/spec/volumes/0/persistentVolumeClaim/claimName
                value: mailu-postfix
              - op: replace
                path: /spec/strategy
                value:
                  type: Recreate
          - target:
              kind: Deployment
              name: mailu-rspamd
            patch:
              - op: add
                path: /spec/template/spec/volumes/0/persistentVolumeClaim/claimName
                value: mailu-rspamd
              - op: replace
                path: /spec/strategy
                value:
                  type: Recreate
