---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: nextcloud
  namespace: storage
spec:
  interval: 15m
  chart:
    spec:
      chart: nextcloud
      version: 3.1.2
      sourceRef:
        kind: HelmRepository
        name: nextcloud-charts
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    image:
      repository: docker.io/nextcloud
      tag: 24.0.5
    nextcloud:
      host: cloud.${DOMAIN}
      username: admin
      password: nextcloud
      mail:
        enabled: true
        fromAddress: ${MAIL_SENDER%@*}
        domain: ${MAIL_SENDER#*@}
        smtp:
          authtype: LOGIN
          host: ${MAIL_HOST}
          port: ${MAIL_PORT}
          name: ${MAIL_USERNAME}
          password: ${MAIL_PASSWORD}
          secure: ssl
      phpConfigs:
        uploadLimit.ini: |
          post_max_size = 32G
          upload_max_filesize = 32G
          max_input_time = 3600
          max_execution_time = 3600
      configs:
        custom.config.php: |
          <?php
          $CONFIG = array (
            'loglevel' => 2,
            'overwrite.cli.url' => 'https://cloud.${DOMAIN}',
            'overwriteprotocol' => 'https',
            'filelocking.enabled' => 'true',
            'trusted_domains' =>
            array (
              0 => 'cloud.${DOMAIN}',
              1 => 'localhost',
            ),
            'trusted_proxies' =>
            array (
              0 => '${K8S_CLUSTER_CIDR}',
            ),
            'forwarded_for_headers' =>
            array (
              0 => 'HTTP_X_FORWARDED_FOR',
            ),
            'default_phone_region' => 'SG',
          );
    cronjob:
      enabled: true
    internalDatabase:
      enabled: false
    postgresql:
      enabled: true
      auth:
        username: nextcloud
        password: nextcloud-pass
        databse: nextcloud
      primary:
        persistence:
          enabled: true
          existingClaim: nextcloud-postgresql
    redis:
      enabled: true
      auth:
        enabled: true
        password: nextcloud-pass
      master:
        persistence:
          enabled: true
          existingClaim: nextcloud-redis
      replica:
        replicaCount: 0
    persistence:
      enabled: true
      existingClaim: nextcloud-config
      nextcloudData:
        enabled: true
        existingClaim: nextcloud-data
    ingress:
      enabled: true
      className: traefik
      path: /
      pathType: Prefix
      tls:
        - hosts:
            - cloud.${DOMAIN}
    podAnnotations:
      secret.reloader.stakater.com/reload: nextcloud-secret
    startupProbe:
      enabled: true
