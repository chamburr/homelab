---
apiVersion: v1
kind: ConfigMap
metadata:
  name: github
  namespace: flux-system
data:
  github.sh: |
    #!/bin/bash

    set -o nounset
    set -o errexit

    now=$(date +%s)
    iat=$(($now - 30))
    exp=$(($now + 570))

    header=$(echo -n '{"alg":"RS256"}' \
      | openssl base64 | tr -d '=' | tr '/+' '_-' | tr -d '\n')
    payload=$(echo -n '{"iat":'"$iat"',"exp":'"$exp"',"iss":'"$APP_ID"'}' \
      | openssl base64 | tr -d '=' | tr '/+' '_-' | tr -d '\n')
    sig=$(openssl dgst -sha256 -sign <(echo -n "$APP_PRIVATE_KEY") <(echo -n "$header.$payload") \
      | openssl base64 | tr -d '=' | tr '/+' '_-' | tr -d '\n')
    jwt="$header.$payload.$sig"

    kubectl patch secret -n flux-system github-secret \
      --patch='{"stringData":{"jwt":"'"$jwt"'"}}'

    updated=$(kubectl get secret -n flux-system github-secret --template='{{.data.updated}}')
    elapsed=$(($now - $(echo "$updated" | openssl base64 -d) + 0))

    if [ "$elapsed" -gt "3300" ]; then
      token=$(curl -s -X POST \
        "https://api.github.com/app/installations/$APP_INSTALLATION/access_tokens" \
        -H "Authorization: Bearer $jwt" \
        -H "Accept: application/vnd.github+json" \
          | jq -j '.token'
      )

      kubectl patch secret -n flux-system github-secret \
        --patch='{"stringData":{"updated":"'"$now"'","token":"'"$token"'"}}'
    fi
