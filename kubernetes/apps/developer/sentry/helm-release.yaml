---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: sentry
  namespace: developer
spec:
  interval: 15m
  chart:
    spec:
      chart: sentry
      version: 15.3.0
      sourceRef:
        kind: HelmRepository
        name: sentry-charts
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    system:
      url: https://sentry.${DOMAIN}
    auth:
      register: false
    user:
      create: false
    mail:
      backend: smtp
      useTls: true
      host: ${MAIL_HOST}
      port: ${MAIL_PORT}
      username: ${MAIL_USERNAME}
      password: ${MAIL_PASSWORD}
      from: ${MAIL_SENDER}
    config:
      sentryConfPy: |
        CSRF_TRUSTED_ORIGINS = ["sentry.${DOMAIN}"]
        SENTRY_BEACON = False
        SENTRY_FEATURES = {
            "auth:register": False,
            "organizations:create": False,
            "organizations:performance-view": False,
            "organizations:data-forwarding": False,
            "organizations:relay": False,
            "organizations:sso-basic": False,
            "organizations:sso-saml2": False,
            "organizations:team-insights": False,
            "projects:data-forwarding": False,
            "projects:plugins": False,
            "projects:sample-events": False,
        }
    sentry:
      web:
        strategyType: Recreate
      worker:
        replicas: 1
    clickhouse:
      clickhouse:
        replicas: 1
        configmap:
          remote_servers:
            internal_replication: false
          zookeeper_servers:
            enabled: false
        persistentVolumeClaim:
          enabled: false
          dataPersistentVolume:
            enabled: true
    zookeeper:
      enabled: false
    kafka:
      replicaCount: 1
      defaultReplicationFactor: 1
      persistence:
        enabled: true
        existingClaim: sentry-kafka
      zookeeper:
        nameOverride: zookeeper
        persistence:
          enabled: true
          existingClaim: sentry-zookeeper
    redis:
      nameOverride: redis
      fullnameOverride: sentry-redis
      master:
        persistence:
          enabled: true
          existingClaim: sentry-redis
      replica:
        replicaCount: 0
    postgresql:
      nameOverride: postgresql
      fullnameOverride: sentry-postgresql
      postgresqlPassword: sentry-pass
      postgresqlPostgresPassword: sentry-pass
      persistence:
        enabled: true
        existingClaim: sentry-postgresql
    rabbitmq:
      enabled: false
    nginx:
      enabled: false
    filestore:
      filesystem:
        persistence:
          enabled: true
          persistentWorkers: false
          existingClaim: sentry-data
    ingress:
      enabled: true
      regexPathStyle: traefik
      ingressClassName: traefik
      hostname: sentry.${DOMAIN}
      tls:
        - hosts:
            - sentry.${DOMAIN}
  postRenderers:
    - kustomize:
        patchesStrategicMerge:
          - $patch: delete
            apiVersion: v1
            kind: ConfigMap
            metadata:
              name: sentry-memcached
