---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: plausible
  namespace: developer
spec:
  interval: 15m
  chart:
    spec:
      chart: plausible-analytics
      version: 0.3.64
      sourceRef:
        kind: HelmRepository
        name: plausible
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    nameOverride: plausible
    fullnameOverride: plausible
    image:
      repository: docker.io/plausible/analytics
      tag: v1.5.1
    disableRegistration: true
    baseURL: https://plausible.${DOMAIN}
    adminUser:
      name: Admin
      email: admin@plausible.local
      password: plausible
    postgresql:
      enabled: true
      url: postgresql://plausible:plausible-pass@plausible-postgresql:5432/plausible
      auth:
        username: plausible
        password: plausible-pass
        database: plausible
      primary:
        persistence:
          enabled: true
          existingClaim: plausible-postgresql
    clickhouse:
      enabled: true
      clickhouse:
        replicas: 1
        configmap:
          remote_servers:
            replica:
              backup:
                enabled: false
          logger:
            level: warning
          profiles:
            enabled: true
            profile:
              - name: default
                config:
                  log_queries: 0
                  log_query_threads: 0
        persistentVolumeClaim:
          enabled: false
          dataPersistentVolume:
            enabled: true
    smtp:
      enabled: true
      mailer:
        emailAddress: ${MAIL_SENDER}
      host: ${MAIL_HOST}
      port: ${MAIL_PORT}
      username: ${MAIL_USERNAME}
      password: ${MAIL_PASSWORD}
    ingress:
      enabled: true
      className: traefik
      hosts:
        - host: plausible.${DOMAIN}
          paths:
            - /
      tls:
        - hosts:
            - plausible.${DOMAIN}
  postRenderers:
    - kustomize:
        patchesJson6902:
          - target:
              kind: ConfigMap
              name: plausible-clickhouse-config
            patch:
              - op: add
                path: /data/zcustom.xml
                value: |
                  <?xml version="1.0"?>
                  <yandex>
                      <query_thread_log remove="remove"/>
                      <query_log remove="remove"/>
                      <text_log remove="remove"/>
                      <trace_log remove="remove"/>
                      <metric_log remove="remove"/>
                      <asynchronous_metric_log remove="remove"/>
                  </yandex>
