---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: mailu
  namespace: mail
spec:
  interval: 15m
  chart:
    spec:
      chart: mailu
      version: 0.3.3
      sourceRef:
        kind: HelmRepository
        name: mailu-charts
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    hostnames:
      - mailu.${DOMAIN}
      - imap.${DOMAIN}
    subnet: ${K8S_CLUSTER_CIDR}
    postmaster: postmaster
    mail:
      messageSizeLimitInMegabytes: 100
    certmanager:
      enabled: false
    front:
      externalService:
        enabled: true
        type: LoadBalancer
        loadBalancerIP: ${METALLB_IP}
        externalTrafficPolicy: Cluster
        annotations:
          metallb.universe.tf/allow-shared-ip: global
        pop3:
          pop3s: false
        smtp:
          smtp: false
          smtps: false
          submission: false
    rspamd:
      resources:
        requests:
          cpu: 500m
          memory: 500Mi
        limits:
          cpu: 600m
          memory: 600Mi
    clamav:
      enabled: false
    roundcube:
      enabled: false
    webdav:
      enabled: true
    fetchmail:
      enabled: false
    persistence:
      single_pvc: true
      existingClaim: mailu-data
    ingress:
      externalIngress: true
      className: traefik
  valuesFrom:
    - kind: Secret
      name: mailu-secret
      valuesKey: admin_user
      targetPath: initialAccount.username
    - kind: Secret
      name: mailu-secret
      valuesKey: admin_domain
      targetPath: initialAccount.domain
    - kind: Secret
      name: mailu-secret
      valuesKey: admin_password
      targetPath: initialAccount.password
    - kind: Secret
      name: mailu-secret
      valuesKey: mail_domain
      targetPath: domain
    - kind: Secret
      name: mailu-secret
      valuesKey: secret_key
      targetPath: secretKey
  postRenderers:
    - kustomize:
        patchesJson6902:
          - target:
              kind: Deployment
              name: mailu-redis
            patch:
              - op: add
                path: /spec/template/spec/volumes/0/persistentVolumeClaim/claimName
                value: mailu-redis
              - op: replace
                path: /spec/strategy
                value:
                  type: Recreate
          - target:
              kind: Deployment
              name: mailu-admin
            patch:
              - op: add
                path: /spec/template/spec/volumes/0/persistentVolumeClaim/claimName
                value: mailu-admin
              - op: replace
                path: /spec/strategy
                value:
                  type: Recreate
          - target:
              kind: Deployment
              name: mailu-dovecot
            patch:
              - op: add
                path: /spec/template/spec/volumes/0/persistentVolumeClaim/claimName
                value: mailu-dovecot
              - op: replace
                path: /spec/strategy
                value:
                  type: Recreate
          - target:
              kind: Deployment
              name: mailu-postfix
            patch:
              - op: add
                path: /spec/template/spec/volumes/0/persistentVolumeClaim/claimName
                value: mailu-postfix
              - op: replace
                path: /spec/strategy
                value:
                  type: Recreate
          - target:
              kind: Deployment
              name: mailu-rspamd
            patch:
              - op: add
                path: /spec/template/spec/volumes/0/persistentVolumeClaim/claimName
                value: mailu-rspamd
              - op: replace
                path: /spec/strategy
                value:
                  type: Recreate
          - target:
              kind: Deployment
              name: mailu-webdav
            patch:
              - op: add
                path: /spec/template/spec/volumes/0/persistentVolumeClaim/claimName
                value: mailu-webdav
              - op: replace
                path: /spec/strategy
                value:
                  type: Recreate
