---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: netmaker
  namespace: networking
spec:
  interval: 15m
  chart:
    spec:
      chart: netmaker
      version: 0.2.0
      sourceRef:
        kind: HelmRepository
        name: netmaker
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    image:
      repository: docker.io/gravitl/netmaker
      tag: v0.16.2
    baseDomain: ${DOMAIN}
    replicas: 1
    ui:
      replicas: 1
    mq:
      replicas: 1
    wireguard:
      enabled: false
    dns:
      enabled: false
    postgresql-ha:
      postgresql:
        replicaCount: 1
      persistence:
        enabled: true
        existingClaim: netmaker-postgresql
    service:
      mqPort: 8883
    ingress:
      enabled: true
      className: traefik
      tls:
        enabled: false
      hostPrefix:
        ui: netmaker.
        rest: netmaker-api.
        broker: netmaker-mq.
    RWXStorageClassName: noop
  postRenderers:
    - kustomize:
        patchesJson6902:
          - target:
              kind: Service
              name: netmaker-wireguard
            patch:
              - op: add
                path: /spec/loadBalancerIP
                value: ${LB_NETMAKER}
              - op: add
                path: /spec/type
                value: LoadBalancer
              - op: replace
                path: /spec/ports
                value:
                  - port: 51821
                    nodePort: 51821
                    protocol: UDP
                    name: wg-iface-51821
                  - port: 51822
                    nodePort: 51822
                    protocol: UDP
                    name: wg-iface-51822
                  - port: 51823
                    nodePort: 51823
                    protocol: UDP
                    name: wg-iface-51823
                  - port: 51824
                    nodePort: 51824
                    protocol: UDP
                    name: wg-iface-51824
                  - port: 51825
                    nodePort: 51825
                    protocol: UDP
                    name: wg-iface-51825
                  - port: 51826
                    nodePort: 51826
                    protocol: UDP
                    name: wg-iface-51826
                  - port: 51827
                    nodePort: 51827
                    protocol: UDP
                    name: wg-iface-51827
                  - port: 51828
                    nodePort: 51828
                    protocol: UDP
                    name: wg-iface-51828
                  - port: 51829
                    nodePort: 51829
                    protocol: UDP
                    name: wg-iface-51829
                  - port: 51830
                    nodePort: 51830
                    protocol: UDP
                    name: wg-iface-51830
          - target:
              kind: Service
              name: netmaker-mqtt-nodeport
            patch:
              - op: add
                path: /spec/loadBalancerIP
                value: ${LB_NETMAKER_MQ}
              - op: add
                path: /spec/type
                value: LoadBalancer
              - op: add
                path: /spec/externalTrafficPolicy
                value: Local
          - target:
              kind: Deployment
              name: netmaker-mqtt
            patch:
              - op: replace
                path: /spec/template/spec/volumes/1/persistentVolumeClaim
                value:
                  claimName: netmaker-certs
          - target:
              kind: Ingress
              name: netmaker-ui
            patch:
              - op: add
                path: /spec/tls
                value:
                  - hosts:
                      - netmaker.${DOMAIN}
          - target:
              kind: Ingress
              name: netmaker-rest
            patch:
              - op: add
                path: /spec/tls
                value:
                  - hosts:
                      - api.netmaker.${DOMAIN}
          - target:
              kind: IngressRouteTCP
              name: netmaker-mq
            patch:
              - op: remove
                path: /spec/tls/secretName
          - target:
              kind: StatefulSet
              name: netmaker
            patch:
              - op: add
                path: /spec/template/spec/containers/0/env/-
                value:
                  name: TELEMETRY
                  value: "off"
              - op: replace
                path: /spec/template/spec/containers/0/env/0
                value:
                  name: SERVER_NAME
                  value: netmaker-mq.${DOMAIN}
              - op: replace
                path: /spec/template/spec/containers/0/env/1
                value:
                  name: SERVER_API_CONN_STRING
                  value: netmaker-api.${DOMAIN}
              - op: replace
                path: /spec/template/spec/containers/0/env/2
                value:
                  name: SERVER_HTTP_HOST
                  value: netmaker-api.${DOMAIN}
              - op: add
                path: /spec/template/spec/containers/0/ports
                value:
                  - containerPort: 51821
                    protocol: UDP
                  - containerPort: 51822
                    protocol: UDP
                  - containerPort: 51823
                    protocol: UDP
                  - containerPort: 51824
                    protocol: UDP
                  - containerPort: 51825
                    protocol: UDP
                  - containerPort: 51826
                    protocol: UDP
                  - containerPort: 51827
                    protocol: UDP
                  - containerPort: 51828
                    protocol: UDP
                  - containerPort: 51829
                    protocol: UDP
                  - containerPort: 51830
                    protocol: UDP
        patchesStrategicMerge:
          - $patch: delete
            apiVersion: v1
            kind: PersistentVolumeClaim
            metadata:
              name: netmaker-shared-certs-pvc
